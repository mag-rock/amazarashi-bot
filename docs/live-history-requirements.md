# ライブ履歴機能 要求仕様書

## 概要

ライブ履歴機能は、amazarashiの楽曲について過去のライブ演奏履歴をTwitterで投稿する機能です。ランダムに選択された曲について、いつどのライブで演奏されたかの詳細情報をスレッド形式で自動投稿します。

## 機能概要

### 主要機能
- 楽曲のライブ演奏履歴をTwitterに自動投稿
- 日次実行による定期投稿
- 複数ツイートによるスレッド形式での詳細情報提供
- 投稿履歴の記録と重複防止

## 投稿内容仕様

### 1. 最初のツイート（基本情報）

**投稿形式：**
```
🎵 『{曲名}』のライブ演奏履歴

📋 セトリ採用回数
　・ツアー/単発公演：{setlistCountOfTour}回
　・フェス/対バン：{setlistCountOfFes}回

🎤 演奏回数：{performanceCount}回

📆 最後の演奏日：{lastPerformanceDate}
　{lastPerformanceLiveName}
```

**含まれる情報：**
- 曲名（タイトル）
- セトリ採用回数（ツアー/単発公演とフェス/対バンで分類）
- 総演奏回数
- 最後に演奏された公演の日付
- 最後に演奏された公演のライブ名

**投稿例：**
```
🎵 『夏を待っていました』のライブ演奏履歴

📋 セトリ採用回数
　・ツアー/単発公演：11回
　・フェス/対バン：11回

🎤 演奏回数：39回

📆 最後の演奏日：2024-08-31
　amazarashi LIVE TOUR 2024「愛と憂鬱」
```

### 2. 続きのツイート（詳細履歴）

ツアー別に以下の形式で投稿：

**公演数が1回の場合：**
```
{ツアー名}（{日付}）
```

**公演数が2-3回の場合：**
```
{ツアー名}（{日付1}, {日付2}, {日付3}）
```

**公演数が4回以上の場合：**
```
{ツアー名}（{開始日} - {終了日} {公演数}回）
```

**投稿例：**
```
amazarashi LIVE TOUR 2024「愛と憂鬱」（2024-07-15 - 2024-08-31 8回）

amazarashi LIVE TOUR 2023「未来になれなかった、あの夜のために」（2023-03-05 - 2023-04-16 5回）

『僕が死のうと思ったのは』完成披露試写会（2022-11-24）

ROCK IN JAPAN FESTIVAL 2022（2022-08-07）

amazarashi one man live 「ボイコット」（2022-04-02, 2022-04-03）
```

## データ構造

### 入力データ

#### 曲一覧データ（Google Sheets）
| 列 | 項目 | 説明 |
|---|---|---|
| A | songId | 曲の一意識別子 |
| B | title | 曲名 |
| C | artist | アーティスト名 |
| D | album | アルバム名 |
| E | releaseDate | リリース日 |
| F | playCount | 演奏回数 |
| G | setlistCountOfTour | セトリ入り公演数（ツアー、単発） |
| H | setlistCountOfFes | セトリ入り公演数（フェス） |

#### 演奏一覧データ（Google Sheets）
| 列 | 項目 | 説明 |
|---|---|---|
| C | tourId | ツアーID |
| D | liveId | ライブID |
| E | tourType | 公演種別 |
| F | domestic | 国内・海外 |
| G | date | 日付（YYYY-MM-DD形式） |
| H | liveName | ライブ名 |
| J | venue | 会場 |
| K | region | 地域 |
| N | songId | 曲ID |
| P | isSetlistPublic | セトリ解禁済（TRUE/FALSE） |

## 処理フロー

### 1. 投稿対象曲の選定
1. Google Sheetsから曲一覧を取得
2. 演奏回数が1回以上の曲をフィルタリング
3. フィルタリングされた曲からランダムに1曲を選定

### 2. 演奏履歴の取得
1. 選定された曲IDに対応する演奏一覧を取得
2. セトリ解禁済み（isSetlistPublic = TRUE）の演奏のみを対象とする
3. 演奏データをツアー別にグループ化

### 3. 投稿テキストの生成
1. 基本情報（曲名、セトリ採用回数、演奏回数）のツイートを作成
2. ツアー別履歴を以下の順序で整理：
   - 各ツアー内の公演を日付昇順でソート
   - ツアーを開始日の降順でソート（最新のツアーが上）
3. Twitter文字数制限（280文字）に応じて複数ツイートに分割

### 4. Twitter投稿
1. 最初のツイートを投稿
2. 続きのツイートをリプライ形式で投稿（スレッド形成）
3. 各投稿のレスポンス情報をFirestoreに保存

## 技術仕様

### 投稿頻度
- 日次実行（1日1回）
- 同日の重複投稿は防止される

### 文字数制限対応
- twitter-textライブラリを使用した重み付け文字数計算
- 280文字制限に応じた自動分割機能

### データ保存
- Firestoreに投稿履歴を保存
- ドキュメントID: `{YYYY-MM-DD}_{songId}`
- 各ツイートのIDと順序を記録

### エラーハンドリング
- データ取得失敗時のエラーログ出力
- 投稿失敗時のリトライ機能
- 例外発生時の適切なエラーレスポンス

## 制約・前提条件

### 選定条件
- 演奏回数が1回以上の曲のみが対象
- セトリ解禁済みの演奏のみを投稿対象とする
- 1日に1曲のみを投稿

### データ品質
- Google Sheetsのデータが正しく入力されていること
- 日付データがYYYY-MM-DD形式で統一されていること
- ツアーIDとライブIDが適切に設定されていること

### システム制約
- Twitter API利用制限の遵守
- Google Sheets API利用制限の遵守
- Cloud Functions実行時間制限（最大9分）内での処理完了

## 拡張予定

### 将来的な改善案
- 単体で長すぎるテキストの自動分割機能
- ユーザーからのリクエスト機能
- 統計情報の追加表示
- 画像付き投稿機能

## 関連ファイル

### 主要実装ファイル
- `src/domain/live-history/liveHistoryLogic.ts` - ビジネスロジック
- `src/application/usecase/live-history/liveHistoryScript.ts` - ユースケース実装
- `src/infrastructure/repository/live-history/liveHistoryRepository.ts` - データアクセス
- `src/types/index.ts` - 型定義

### 設定・データファイル
- `sample-data/live-history-sheet.csv` - サンプルデータ
- Google Sheets（曲一覧・ライブ演奏一覧）
- 環境設定ファイル（Twitter API認証情報等） 